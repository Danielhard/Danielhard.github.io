<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>VUE3源码解析 | Danielhard的前端笔记</title>
    <meta name="description" content="step by step for a Full stack">
    
    
    <link rel="preload" href="/assets/css/0.styles.a02f6941.css" as="style"><link rel="preload" href="/assets/js/app.5c6037cb.js" as="script"><link rel="preload" href="/assets/js/2.082e12d9.js" as="script"><link rel="preload" href="/assets/js/46.e605b212.js" as="script"><link rel="prefetch" href="/assets/js/10.9deb2a08.js"><link rel="prefetch" href="/assets/js/11.842648f5.js"><link rel="prefetch" href="/assets/js/12.d3d6d6a2.js"><link rel="prefetch" href="/assets/js/13.f678d7f6.js"><link rel="prefetch" href="/assets/js/14.fcbf7455.js"><link rel="prefetch" href="/assets/js/15.7cf0b9e8.js"><link rel="prefetch" href="/assets/js/16.d23d7877.js"><link rel="prefetch" href="/assets/js/17.71f474e7.js"><link rel="prefetch" href="/assets/js/18.b524aa71.js"><link rel="prefetch" href="/assets/js/19.448a8713.js"><link rel="prefetch" href="/assets/js/20.9d3518c1.js"><link rel="prefetch" href="/assets/js/21.1c2d03ec.js"><link rel="prefetch" href="/assets/js/22.5c5233a2.js"><link rel="prefetch" href="/assets/js/23.80f19ee8.js"><link rel="prefetch" href="/assets/js/24.b87cd00f.js"><link rel="prefetch" href="/assets/js/25.fbb4af51.js"><link rel="prefetch" href="/assets/js/26.7781b184.js"><link rel="prefetch" href="/assets/js/27.4065852b.js"><link rel="prefetch" href="/assets/js/28.2c772aeb.js"><link rel="prefetch" href="/assets/js/29.aeb8adbd.js"><link rel="prefetch" href="/assets/js/3.4f8d9a06.js"><link rel="prefetch" href="/assets/js/30.f4a63fbc.js"><link rel="prefetch" href="/assets/js/31.7401067b.js"><link rel="prefetch" href="/assets/js/32.dacd01a8.js"><link rel="prefetch" href="/assets/js/33.b4caf845.js"><link rel="prefetch" href="/assets/js/34.1fecdd8f.js"><link rel="prefetch" href="/assets/js/35.3256e4f8.js"><link rel="prefetch" href="/assets/js/36.b6a81b1a.js"><link rel="prefetch" href="/assets/js/37.e8212bcc.js"><link rel="prefetch" href="/assets/js/38.13adce45.js"><link rel="prefetch" href="/assets/js/39.090a1cfa.js"><link rel="prefetch" href="/assets/js/4.167f4d3b.js"><link rel="prefetch" href="/assets/js/40.13501eeb.js"><link rel="prefetch" href="/assets/js/41.c66148b8.js"><link rel="prefetch" href="/assets/js/42.45d8454b.js"><link rel="prefetch" href="/assets/js/43.f4ce8f7e.js"><link rel="prefetch" href="/assets/js/44.c14e2024.js"><link rel="prefetch" href="/assets/js/45.bc1af6e4.js"><link rel="prefetch" href="/assets/js/47.3d074211.js"><link rel="prefetch" href="/assets/js/48.08e28418.js"><link rel="prefetch" href="/assets/js/49.4b565f02.js"><link rel="prefetch" href="/assets/js/5.db9199f1.js"><link rel="prefetch" href="/assets/js/50.255f038b.js"><link rel="prefetch" href="/assets/js/51.3edef65b.js"><link rel="prefetch" href="/assets/js/52.476f761c.js"><link rel="prefetch" href="/assets/js/53.8b55355b.js"><link rel="prefetch" href="/assets/js/54.8411ba2f.js"><link rel="prefetch" href="/assets/js/55.7764be3c.js"><link rel="prefetch" href="/assets/js/56.36aa97c2.js"><link rel="prefetch" href="/assets/js/57.6d39658a.js"><link rel="prefetch" href="/assets/js/6.768f9de4.js"><link rel="prefetch" href="/assets/js/7.20a18e96.js"><link rel="prefetch" href="/assets/js/8.f9f6b6a6.js"><link rel="prefetch" href="/assets/js/9.44d7f83b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a02f6941.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Danielhard的前端笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/FE/introduction.html" class="nav-link">FE</a></div><div class="nav-item"><a href="https://github.com/Danielhard" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/FE/introduction.html" class="nav-link">FE</a></div><div class="nav-item"><a href="https://github.com/Danielhard" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>js基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TypeScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>QA</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MVVM相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端工程化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>源码解析</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/FE/sourceCode/vue2.html" class="sidebar-link">VUE2源码解析</a></li><li><a href="/FE/sourceCode/vue3.html" class="active sidebar-link">VUE3源码解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE/sourceCode/vue3.html#回顾" class="sidebar-link">回顾</a></li><li class="sidebar-sub-header"><a href="/FE/sourceCode/vue3.html#基础" class="sidebar-link">基础</a></li><li class="sidebar-sub-header"><a href="/FE/sourceCode/vue3.html#整体流程" class="sidebar-link">整体流程</a></li><li class="sidebar-sub-header"><a href="/FE/sourceCode/vue3.html#目录结构" class="sidebar-link">目录结构</a></li><li class="sidebar-sub-header"><a href="/FE/sourceCode/vue3.html#reactivity" class="sidebar-link">reactivity</a></li><li class="sidebar-sub-header"><a href="/FE/sourceCode/vue3.html#vnode" class="sidebar-link">vnode</a></li></ul></li><li><a href="/FE/sourceCode/redux.html" class="sidebar-link">redux源码解析</a></li><li><a href="/FE/sourceCode/reactHooks.html" class="sidebar-link">ReactHooks16.13分析</a></li><li><a href="/FE/sourceCode/react.html" class="sidebar-link">React16.13源码解析</a></li><li><a href="/FE/sourceCode/webpack.html" class="sidebar-link">~~</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>php</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Nginx</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MySQL</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vue3源码解析"><a href="#vue3源码解析" aria-hidden="true" class="header-anchor">#</a> VUE3源码解析</h1> <p><strong>版本3.0.0-alpha.1</strong>  (与最新版本差距不大)</p> <h2 id="回顾"><a href="#回顾" aria-hidden="true" class="header-anchor">#</a> 回顾</h2> <p>首先先回顾一下vue2</p> <div class="language-bash extra-class"><pre class="language-bash"><code> <span class="token variable">$set</span> <span class="token operator">==</span><span class="token operator">&gt;</span>object.definproperty

    <span class="token number">1</span>. <span class="token assign-left variable">Observer</span><span class="token operator">==</span><span class="token operator">&gt;</span>object.definproperty<span class="token operator">==</span><span class="token operator">&gt;</span>Object<span class="token punctuation">(</span>key<span class="token punctuation">)</span>,array<span class="token punctuation">(</span>重写<span class="token punctuation">)</span> 

       get     dep.depend<span class="token operator">==</span><span class="token operator">&gt;</span>Watcher.addSub<span class="token operator">==</span><span class="token operator">&gt;</span>Dep<span class="token punctuation">[</span>watcher<span class="token punctuation">]</span>

       <span class="token builtin class-name">set</span>     Dep.notify<span class="token operator">==</span><span class="token operator">&gt;</span>watcher.update<span class="token operator">==</span><span class="token operator">&gt;</span>render<span class="token operator">==</span><span class="token operator">&gt;</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">&gt;</span>Vnode<span class="token operator">==</span><span class="token operator">&gt;</span>dom diff<span class="token punctuation">(</span>修改diff 对应的component！！并不是整个页面的dom <span class="token function">diff</span><span class="token punctuation">)</span>

       react （diff 整个页面的Vnode）

   <span class="token number">2</span>. Dep 收集依赖  订阅发布模式  <span class="token punctuation">(</span>大爷电话本<span class="token punctuation">)</span>  EventEmit <span class="token punctuation">(</span>node<span class="token punctuation">)</span>

   <span class="token number">3</span>. Watcher  连接对应的render函数 --<span class="token operator">&gt;</span>  component<span class="token punctuation">(</span>teamplate<span class="token punctuation">)</span>  

       dep.target<span class="token operator">=</span>Watcher

   <span class="token number">4</span>. render  <span class="token operator">==</span><span class="token operator">&gt;</span>

   with<span class="token punctuation">(</span>this<span class="token punctuation">)</span><span class="token punctuation">{</span>

       <span class="token punctuation">..</span>.<span class="token punctuation">(</span>name<span class="token punctuation">)</span>

   <span class="token punctuation">}</span>
   https://vue-template-explorer.netlify.app/      vue2在线解析
   vue编译完成之后是用的with<span class="token operator">==</span><span class="token operator">&gt;</span>提升作用域链
   vue2 使用 正则匹配 进行编译 <span class="token operator">==</span><span class="token operator">&gt;</span>with<span class="token punctuation">(</span>this<span class="token punctuation">)</span><span class="token punctuation">{</span>
   		a
   <span class="token punctuation">}</span>
   正则匹配的性能瓶颈较高。
</code></pre></div><h2 id="基础"><a href="#基础" aria-hidden="true" class="header-anchor">#</a> 基础</h2> <p>Vue3 发布之后，说到了性能比之前提升了十倍。基本上是两个点的改变最大：</p> <ol><li>模板解析，使用AST(抽象语法树)替代了正则匹配</li> <li>vue3 内部的数据监听发生了变换 object.definproperty==&gt;Proxy</li></ol> <p>所以我们需要先了解一下：</p> <p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy" target="_blank" rel="noopener noreferrer">Proxy<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://astexplorer.net/" target="_blank" rel="noopener noreferrer">抽象语法书在线解析<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://github.com/antlr" target="_blank" rel="noopener noreferrer">抽象语法树规则<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://vue-next-template-explorer.netlify.app/" target="_blank" rel="noopener noreferrer">vue3在线解析<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>vue最大的优点就是可以进行编译时优化 ，而不必全部放在运行时</p> <h2 id="整体流程"><a href="#整体流程" aria-hidden="true" class="header-anchor">#</a> 整体流程</h2> <p><img src="/sourceCode/vue3/all.png" alt="all"></p> <h2 id="目录结构"><a href="#目录结构" aria-hidden="true" class="header-anchor">#</a> 目录结构</h2> <p>接下来我们进入正题，首先看看VUE3的代码结构(<a href="https://github.com/vuejs/vue-next" target="_blank" rel="noopener noreferrer">源代码地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)</p> <p><img src="/sourceCode/vue3/1598496593241_4A74F3AE-7D4F-4350-9E65-7664B1D6D610.png" alt="1598496593241_4A74F3AE-7D4F-4350-9E65-7664B1D6D610"></p> <p>其中有个叫<code>lerna.json</code>的文件，使用了<a href="https://github.com/lerna/lerna" target="_blank" rel="noopener noreferrer">lerna<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>作为项目管理工具。</p> <p>Lerna:一个用于管理具有多个包的JavaScript项目的工具。</p> <p>具体的源代码文件在<code>packages</code>文件夹下，先来看一下结构：</p> <blockquote><p>reactivity    数据响应式系统</p> <p>compiler-core   编译器 AST</p> <p>compiler-dom    AST==&gt;render</p> <p>compiler-sfc   解析.vue</p> <p>compiler-ssr  服务端渲染的处理</p> <p>runtime-core  与平台无关的运行时</p> <p>runtime-dom   document  setSate 与端接触的运行时（浏览器端）  暴露了端口 接入平台相关操作的端口</p> <p>template-explorer vue3 模板在线编译代码</p> <p>...</p></blockquote> <p>接下来我们来看看<code>reactivity</code></p> <h2 id="reactivity"><a href="#reactivity" aria-hidden="true" class="header-anchor">#</a> reactivity</h2> <p>首先看一下目录结构</p> <div class="language- extra-class"><pre class="language-text"><code>├── LICENSE 
├── README.md
├── __tests__
├── api-extractor.json
├── dist
├── index.js
├── package.json
└── src
</code></pre></div><p>主要功能文件在src下，这边想先说的是tests文件夹。vue3源码中每个文件夹下面都有tests文件夹，保存了一些测试例子，可以用jest直接跑一下试试搭配源码去理解。</p> <p><code>jest runner</code>插件可以右键直接执行某个单侧</p> <h3 id="数据响应架构"><a href="#数据响应架构" aria-hidden="true" class="header-anchor">#</a> 数据响应架构</h3> <p>先看一下数据响应架构图，然后留个印象，接着继续往下看</p> <p><img src="/sourceCode/vue3/dataResponseArchitecture.png" alt="dataResponseArchitecture"></p> <h3 id="src"><a href="#src" aria-hidden="true" class="header-anchor">#</a> src</h3> <div class="language- extra-class"><pre class="language-text"><code>.
├── baseHandlers.ts
├── collectionHandlers.ts
├── computed.ts
├── effect.ts
├── index.ts
├── lock.ts
├── operations.ts
├── reactive.ts
└── ref.ts
</code></pre></div><p>写一个简单的例子</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>./reactivity.global.js<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
        <span class="token keyword">const</span> <span class="token punctuation">{</span>reactive<span class="token punctuation">,</span>effect<span class="token punctuation">}</span><span class="token operator">=</span>VueObserver<span class="token punctuation">;</span>

        <span class="token keyword">const</span> obj<span class="token operator">=</span><span class="token punctuation">{</span>count<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> state<span class="token operator">=</span><span class="token function">reactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//返回一个监听的新数据</span>
        <span class="token keyword">const</span> <span class="token function-variable function">fn</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">const</span> count<span class="token operator">=</span>state<span class="token punctuation">.</span>count<span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'当前的count是个啥？'</span><span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
       <span class="token function">effect</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>上面state已经变成了响应式数据，当state发生了变化是，<code>effect(fn)</code>会调用,看一下执行结果</p> <p><img src="/Users/liuxiaodong/Desktop/blog/note/docs/.vuepress/public/sourceCode/vue3/1598510425821_67688896-0B51-4CB2-9CD7-3BE1EADB44B4.png" alt="1598510425821_67688896-0B51-4CB2-9CD7-3BE1EADB44B4"></p> <p>可以看出来，<code>proxy</code>是对目标对象进行了代理（劫持），跟之前的object.definproperty区别是他可以监听新增的，他是代理了对这个对象的操作。当然，他也有缺点，他只能代理一层的。层级深了就处理不了了。所以我们看看源码里是怎么处理的。</p> <h3 id="reactive-ts"><a href="#reactive-ts" aria-hidden="true" class="header-anchor">#</a> reactive.ts</h3> <p>reactive: 本库的核心方法，传递一个object类型的原始数据，</p> <p>通过Proxy，返回一个代理数据。在这过程中，劫持了原始数据的任何读写操作。</p> <p>进而实现改变代理数据时，能触发依赖其的监听函数effect。</p> <p>我们先来看一下他的单测文件</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> ref<span class="token punctuation">,</span> isRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../src/ref'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> reactive<span class="token punctuation">,</span> isReactive<span class="token punctuation">,</span> toRaw<span class="token punctuation">,</span> markNonReactive <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../src/reactive'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> mockWarn <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/runtime-test'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> computed <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../src/computed'</span>
<span class="token comment">/**
 * 它能接受一个对象或数组，返回新的响应数据。
 * 响应数据跟原始数据就跟影子一样，
 * 对任何一方的任何操作都能同步到对方身上。
 */</span>
<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'reactivity/reactive'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">mockWarn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'Object'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> original <span class="token operator">=</span> <span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>

    <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>observed<span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>observed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token comment">// get</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">// has</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">'foo'</span> <span class="token keyword">in</span> observed<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token comment">// ownKeys</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>observed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'Array'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> original <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>observed<span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>observed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>observed<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token comment">// get</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>observed<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">// has</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token keyword">in</span> observed<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token comment">// ownKeys</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>observed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'0'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'Array long'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> original <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span>
    observed<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment">// ownKeys</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'cloned reactive Array should point to observed values'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> original <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span>
    <span class="token keyword">const</span> clone <span class="token operator">=</span> observed<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//原数组不会改变，调用每一个key ，拿到数据后，如果是对象，就处理迭代</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>clone<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>clone<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>original<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>clone<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>observed<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'nested reactives'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> original <span class="token operator">=</span> <span class="token punctuation">{</span>
      nested<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        foo<span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      array<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> bar<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>nested<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>array<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'observed value should proxy mutations to original (Object)'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> original<span class="token punctuation">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
    <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span>
    <span class="token comment">// set</span>
    observed<span class="token punctuation">.</span>bar <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>bar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>original<span class="token punctuation">.</span>bar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">// delete</span>
    <span class="token keyword">delete</span> original<span class="token punctuation">.</span>foo
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>foo<span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">'foo'</span> <span class="token keyword">in</span> observed<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">'foo'</span> <span class="token keyword">in</span> original<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'observed value should proxy mutations to original (Array)'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> original<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> bar<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span>
    <span class="token comment">// set</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token punctuation">{</span> baz<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token punctuation">}</span>
    <span class="token keyword">const</span> reactiveValue <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    observed<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> value
    <span class="token function">expect</span><span class="token punctuation">(</span>observed<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>reactiveValue<span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>original<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token comment">// delete</span>
    <span class="token keyword">delete</span> observed<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>observed<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeUndefined</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>original<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeUndefined</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// mutating methods</span>
    observed<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>observed<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>reactiveValue<span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>original<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">/**
   * vue2中相应数据需要一开始就声明好key，vue3，可以随时添加
   */</span>
  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'setting a property with an unobserved value should wrap with reactive'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> observed <span class="token operator">=</span> reactive<span class="token operator">&lt;</span><span class="token punctuation">{</span> foo<span class="token operator">?</span><span class="token punctuation">:</span> object <span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> raw <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    observed<span class="token punctuation">.</span>foo <span class="token operator">=</span> raw
    <span class="token function">expect</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">/**
   * 重复处理
   */</span>
  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'observing already observed value should return same Proxy'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> original <span class="token operator">=</span> <span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
    <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span>
    <span class="token keyword">const</span> observed2 <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>observed<span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>observed2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>observed<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">/**
   * 同样的数据处理
   */</span>
  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'observing the same value multiple times should return same Proxy'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> original <span class="token operator">=</span> <span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
    <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span>
    <span class="token keyword">const</span> observed2 <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>observed2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>observed<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'should not pollute original object with Proxies'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> original<span class="token punctuation">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
    <span class="token keyword">const</span> original2 <span class="token operator">=</span> <span class="token punctuation">{</span> bar<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>
    <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span>
    <span class="token keyword">const</span> observed2 <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>original2<span class="token punctuation">)</span>
    observed<span class="token punctuation">.</span>bar <span class="token operator">=</span> observed2
    <span class="token function">expect</span><span class="token punctuation">(</span>observed<span class="token punctuation">.</span>bar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>observed2<span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>original<span class="token punctuation">.</span>bar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>original2<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">/**
   * get row data
   */</span>
  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'unwrap'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> original <span class="token operator">=</span> <span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
    <span class="token keyword">const</span> observed <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">toRaw</span><span class="token punctuation">(</span>observed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">toRaw</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'should not unwrap Ref&lt;T&gt;'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> observedNumberRef <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> observedObjectRef <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>observedNumberRef<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>observedObjectRef<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'should unwrap computed refs'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// readonly</span>
    <span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">// writable</span>
    <span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token function-variable function">get</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token function-variable function">set</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> a<span class="token punctuation">,</span> b <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// check type</span>
    obj<span class="token punctuation">.</span>a <span class="token operator">+</span> <span class="token number">1</span>
    obj<span class="token punctuation">.</span>b <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> obj<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">number</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> obj<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">number</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">/**
   * 不能被代理，基础类型，promise、Date、RegExp返回本身
   */</span>
  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'non-observable values'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">assertValue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">:</span> <span class="token builtin">any</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">reactive</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">value cannot be made reactive: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">String</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenWarnedLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// number</span>
    <span class="token function">assertValue</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">// string</span>
    <span class="token function">assertValue</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span>
    <span class="token comment">// boolean</span>
    <span class="token function">assertValue</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token comment">// null</span>
    <span class="token function">assertValue</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token comment">// undefined</span>
    <span class="token function">assertValue</span><span class="token punctuation">(</span>undefined<span class="token punctuation">)</span>
    <span class="token comment">// symbol</span>
    <span class="token keyword">const</span> s <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">assertValue</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>

    <span class="token comment">// built-ins should work and return same value</span>
    <span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">reactive</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    <span class="token keyword">const</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">reactive</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
    <span class="token keyword">const</span> d <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">reactive</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">/**
   * 标记不能被代理的数据
   */</span>
  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'markNonReactive'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      foo<span class="token punctuation">:</span> <span class="token punctuation">{</span> a<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      bar<span class="token punctuation">:</span> <span class="token function">markNonReactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> b<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>bar<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>上面单测文件中可以反推出一些功能。(vue3单测文件写得还不错，建议看源码的时候一起看)</p> <p><code>reactive.ts</code></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> isObject<span class="token punctuation">,</span> toRawType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/shared'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> mutableHandlers<span class="token punctuation">,</span> readonlyHandlers <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./baseHandlers'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  mutableCollectionHandlers<span class="token punctuation">,</span>
  readonlyCollectionHandlers
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./collectionHandlers'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ReactiveEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./effect'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UnwrapRef<span class="token punctuation">,</span> Ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./ref'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> makeMap <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/shared'</span>

<span class="token comment">//这个WeakMap储存着（target-&gt; key-&gt;dep）,在概念上，把依赖看着Dep 类维护了一组订阅，更好理解，</span>
<span class="token comment">//我们只是把它储存为原始set 可以减少内存开销</span>

<span class="token keyword">export</span> <span class="token keyword">type</span> Dep <span class="token operator">=</span> Set<span class="token operator">&lt;</span>ReactiveEffect<span class="token operator">&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> KeyToDepMap <span class="token operator">=</span> Map<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> Dep<span class="token operator">&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> targetMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> KeyToDepMap<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// WeakMaps that store {raw &lt;-&gt; observed} pairs.</span>
<span class="token comment">//原始数据到响应数据之间的映射</span>
<span class="token keyword">const</span> rawToReactive <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> reactiveToRaw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> rawToReadonly <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> readonlyToRaw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> readonlyValues <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakSet</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> nonReactiveValues <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakSet</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> collectionTypes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token operator">&lt;</span><span class="token builtin">Function</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Set<span class="token punctuation">,</span> Map<span class="token punctuation">,</span> WeakMap<span class="token punctuation">,</span> WeakSet<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> isObservableType <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">makeMap</span><span class="token punctuation">(</span>
  <span class="token string">'Object,Array,Map,Set,WeakMap,WeakSet'</span>
<span class="token punctuation">)</span>

<span class="token comment">/**
 * 判断是否可以observable
 * @param value
 */</span>
<span class="token keyword">const</span> canObserve <span class="token operator">=</span> <span class="token punctuation">(</span>value<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token parameter"><span class="token builtin">boolean</span></span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token comment">//不是Vue对象</span>
    <span class="token operator">!</span>value<span class="token punctuation">.</span>_isVue <span class="token operator">&amp;&amp;</span>
    <span class="token comment">//不是VNode</span>
    <span class="token operator">!</span>value<span class="token punctuation">.</span>_isVNode <span class="token operator">&amp;&amp;</span>
    <span class="token comment">//是Object、Array、Map、Set、WeakMap、WeakSet</span>
    <span class="token function">isObservableType</span><span class="token punctuation">(</span><span class="token function">toRawType</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token comment">//没有被代理过</span>
    <span class="token operator">!</span>nonReactiveValues<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// only unwrap nested ref</span>
<span class="token keyword">type</span> UnwrapNestedRefs<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">Ref</span> <span class="token operator">?</span> <span class="token constant">T</span> <span class="token punctuation">:</span> UnwrapRef<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> reactive<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">object</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>target<span class="token punctuation">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token punctuation">:</span> UnwrapNestedRefs<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">:</span> object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// if trying to observe a readonly proxy, return the readonly version.</span>
  <span class="token comment">//如果target是只读，返回这个target</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>readonlyToRaw<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> target
  <span class="token punctuation">}</span>
  <span class="token comment">// target is explicitly marked as readonly by user</span>
  <span class="token comment">//target被用户标记成了只读，那么就让他变成只读，并返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>readonlyValues<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">readonly</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
    { {a:1}:Proxy }
  */</span>
  <span class="token comment">//创建响应式数据</span>
  <span class="token keyword">return</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>
    target<span class="token punctuation">,</span> <span class="token comment">//原始值</span>
    rawToReactive<span class="token punctuation">,</span> <span class="token comment">//原始值到响应数据的映射  { {a:1}:Proxy }</span>
    reactiveToRaw<span class="token punctuation">,</span> <span class="token comment">//响应数据到原始值的映射 { Proxy:{a:1} }</span>
    mutableHandlers<span class="token punctuation">,</span>
    mutableCollectionHandlers
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token keyword">readonly</span><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">object</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
  target<span class="token punctuation">:</span> <span class="token constant">T</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> Readonly<span class="token operator">&lt;</span>UnwrapNestedRefs<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// value is a mutable observable, retrieve its original and return</span>
  <span class="token comment">// a readonly version.</span>
  <span class="token comment">//如果值已经是响应类型的值了，那么就取出他的原始值</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>reactiveToRaw<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target <span class="token operator">=</span> reactiveToRaw<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//创建响应对象</span>
  <span class="token keyword">return</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>
    target<span class="token punctuation">,</span> <span class="token comment">//原始值</span>
    rawToReadonly<span class="token punctuation">,</span> <span class="token comment">//原始值到只读数据的映射</span>
    readonlyToRaw<span class="token punctuation">,</span> <span class="token comment">//只读数据到原始值的映射</span>
    readonlyHandlers<span class="token punctuation">,</span>
    readonlyCollectionHandlers
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 创建响应类型
 * @param target
 * @param toProxy
 * @param toRaw
 * @param baseHandlers
 * @param collectionHandlers
 */</span>
<span class="token keyword">function</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>
  <span class="token parameter">target<span class="token punctuation">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span>
  toProxy<span class="token punctuation">:</span> WeakMap<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  toRaw<span class="token punctuation">:</span> WeakMap<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  baseHandlers<span class="token punctuation">:</span> ProxyHandler<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  collectionHandlers<span class="token punctuation">:</span> ProxyHandler<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//判断是否是基本元素（数字、字符串、布尔），如果是基本元素，就直接返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">value cannot be made reactive: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">String</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> target
  <span class="token punctuation">}</span>
  <span class="token comment">// target already has corresponding Proxy</span>
  <span class="token comment">//获取已经处理过的对象（可相应的、只读的）</span>
  <span class="token keyword">let</span> observed <span class="token operator">=</span> toProxy<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token comment">///原始值到响应数据的映射  { {a:1}:Proxy }</span>
  <span class="token comment">//如果已经有了处理过的对象（可相应的、只读的），直接返回此对象</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>observed <span class="token operator">!==</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> observed
  <span class="token punctuation">}</span>
  <span class="token comment">// target is already a Proxy</span>
  <span class="token comment">//数据已经是一个处理过的对象（可相应的、只读的），返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>toRaw<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//响应数据到原始值的映射 { Proxy:{a:1} }</span>
    <span class="token keyword">return</span> target
  <span class="token punctuation">}</span>
  <span class="token comment">// only a whitelist of value types can be observed.</span>
  <span class="token comment">//只有白名单的对象才可以被代理</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">canObserve</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> target
  <span class="token punctuation">}</span>
  <span class="token comment">//collectionTypes表示Set, Map, WeakMap, WeakSet的集合，判断对象是否是这几种类型，来使用不同的处理函数</span>
  <span class="token keyword">const</span> handlers <span class="token operator">=</span> collectionTypes<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token keyword">constructor</span><span class="token punctuation">)</span>
    <span class="token operator">?</span> collectionHandlers
    <span class="token punctuation">:</span> baseHandlers

  <span class="token comment">//数据处理</span>
  observed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> handlers<span class="token punctuation">)</span><span class="token comment">//{get(){},set(){}}</span>

  toProxy<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> observed<span class="token punctuation">)</span> <span class="token comment">//设置原始数据到处理后的数据的弱引用</span>
  toRaw<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>observed<span class="token punctuation">,</span> target<span class="token punctuation">)</span> <span class="token comment">//设置处理后的数据到原始数据的弱引用</span>

  <span class="token comment">//如果之前数据没有处理过，那么就设置target到key到Dep的引用关系</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>targetMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    targetMap<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> observed
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isReactive</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">:</span> <span class="token builtin">unknown</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> reactiveToRaw<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> readonlyToRaw<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isReadonly</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">:</span> <span class="token builtin">unknown</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> readonlyToRaw<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 获取原始数据
 * @param observed
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> toRaw<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>observed<span class="token punctuation">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token constant">T</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> reactiveToRaw<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>observed<span class="token punctuation">)</span> <span class="token operator">||</span> readonlyToRaw<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>observed<span class="token punctuation">)</span> <span class="token operator">||</span> observed
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 标记数据为只读数据
 * @param value
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> markReadonly<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token constant">T</span> <span class="token punctuation">{</span>
  readonlyValues<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token keyword">return</span> value
<span class="token punctuation">}</span>

<span class="token comment">//标记没有被处理过的数据</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> markNonReactive<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token constant">T</span> <span class="token punctuation">{</span>
  nonReactiveValues<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token keyword">return</span> value
<span class="token punctuation">}</span>
</code></pre></div><p>这个文件输出了<code>reactive</code>方法，可以把数据处理，然后返回一个被代理过的数据。然后处理了一些小细节和容错。处理完成之后，当改变数据是，便可触发其监听函数<code>effect</code>。</p> <h3 id="effect-ts"><a href="#effect-ts" aria-hidden="true" class="header-anchor">#</a> effect.ts</h3> <p>这块儿我们先看一个简单的测试用例</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should observe basic properties'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> dummy
  <span class="token keyword">const</span> counter <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> num<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>dummy <span class="token operator">=</span> counter<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  counter<span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">7</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>基本能力：传递给effect的方法，会立即执行一次</p> <p>先简单的说一下<code>effect.js</code>流程：</p> <ul><li><p>effect：接受一个函数，返回一个新的监听函数 reactiveEffect 。</p></li> <li><p>若监听函数内部依赖了reactive数据，当这些数据变更时会触发监听函数。</p></li> <li><p>绑定阶段：effect 函数会包装传入的 方法，</p></li> <li><p>将其变成一个 effect 对象，并在绑定阶段的最后执行一遍传入的 方法（初始化）。</p></li> <li><p>收集阶段：effect 传入的方法内部，有响应式对象参与了计算，</p></li> <li><p>将触发 get 操作，会执行 track 方法，track 方法的重点是</p></li> <li><p>将响应式对象改变的target 与 绑定阶段的 effect 对象一一对应起来。</p></li> <li><p>这两个阶段是同步执行的（activeReactiveEffectStack 协调），值会存在全局的 targetMap。</p></li> <li><p>触发阶段：当 响应式对象 set 时，</p></li> <li><p>会触发 trigger 方法，它会从 targetMap 中拿到</p></li> <li><p>target 对应的 effects，并遍历执行。</p></li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> OperationTypes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./operations'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Dep<span class="token punctuation">,</span> targetMap <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./reactive'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">EMPTY_OBJ</span><span class="token punctuation">,</span> extend <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/shared'</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> effectSymbol <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>__DEV__ <span class="token operator">?</span> <span class="token string">'effect'</span> <span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ReactiveEffect</span><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token constant">T</span>
  _isEffect<span class="token punctuation">:</span> <span class="token boolean">true</span>
  active<span class="token punctuation">:</span> <span class="token builtin">boolean</span>
  <span class="token function-variable function">raw</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">T</span>
  deps<span class="token punctuation">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>Dep<span class="token operator">&gt;</span>
  options<span class="token punctuation">:</span> ReactiveEffectOptions
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ReactiveEffectOptions</span> <span class="token punctuation">{</span>
  lazy<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span>
  computed<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span>
  scheduler<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">run<span class="token punctuation">:</span> <span class="token builtin">Function</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
  onTrack<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">:</span> DebuggerEvent</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
  onTrigger<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">:</span> DebuggerEvent</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
  onStop<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">type</span> DebuggerEvent <span class="token operator">=</span> <span class="token punctuation">{</span>
  effect<span class="token punctuation">:</span> ReactiveEffect
  target<span class="token punctuation">:</span> object
  <span class="token keyword">type</span><span class="token punctuation">:</span> OperationTypes
  key<span class="token punctuation">:</span> <span class="token builtin">any</span>
<span class="token punctuation">}</span> <span class="token operator">&amp;</span> DebuggerEventExtraInfo

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">DebuggerEventExtraInfo</span> <span class="token punctuation">{</span>
  newValue<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">any</span>
  oldValue<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">any</span>
  oldTarget<span class="token operator">?</span><span class="token punctuation">:</span> Map<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token operator">|</span> Set<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> effectStack<span class="token punctuation">:</span> ReactiveEffect<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">ITERATE_KEY</span> <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'iterate'</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isEffect</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">:</span> <span class="token builtin">any</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> fn <span class="token keyword">is</span> ReactiveEffect <span class="token punctuation">{</span>
  <span class="token keyword">return</span> fn <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> fn<span class="token punctuation">.</span>_isEffect <span class="token operator">===</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

<span class="token comment">//() =&gt; (dummy = counter.num)入口功能</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> effect<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
  <span class="token function-variable function">fn</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">T</span><span class="token punctuation">,</span>
  options<span class="token punctuation">:</span> ReactiveEffectOptions <span class="token operator">=</span> <span class="token constant">EMPTY_OBJ</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> ReactiveEffect<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//判断是否为Effect处理过的</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isEffect</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fn <span class="token operator">=</span> fn<span class="token punctuation">.</span>raw
  <span class="token punctuation">}</span>
  <span class="token comment">//() =&gt; (dummy = counter.num) 处理流程函数，返回来一个函数---往下看函数的处理流程</span>
  <span class="token keyword">const</span> effect <span class="token operator">=</span> <span class="token function">createReactiveEffect</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token comment">//第一次执行，不会懒加载</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//执行的run</span>
    <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> effect
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token parameter">effect<span class="token punctuation">:</span> ReactiveEffect</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>effect<span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">cleanup</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span>onStop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    effect<span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//() =&gt; (dummy = counter.num) 这块儿是重点</span>
<span class="token keyword">function</span> createReactiveEffect<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
  <span class="token function-variable function">fn</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">T</span><span class="token punctuation">,</span>
  options<span class="token punctuation">:</span> ReactiveEffectOptions
<span class="token punctuation">)</span><span class="token punctuation">:</span> ReactiveEffect<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">effect</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">reactiveEffect</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args<span class="token punctuation">:</span> <span class="token builtin">unknown</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">unknown</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">run</span><span class="token punctuation">(</span>effect<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">as</span> ReactiveEffect

  effect<span class="token punctuation">.</span>_isEffect <span class="token operator">=</span> <span class="token boolean">true</span>
  effect<span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">true</span>
  effect<span class="token punctuation">.</span>raw <span class="token operator">=</span> fn
  effect<span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token comment">//在执行对应监听函数时，收集函数内部的其他依赖</span>
  effect<span class="token punctuation">.</span>options <span class="token operator">=</span> options

  <span class="token keyword">return</span> effect
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token parameter">effect<span class="token punctuation">:</span> ReactiveEffect<span class="token punctuation">,</span> fn<span class="token punctuation">:</span> <span class="token builtin">Function</span><span class="token punctuation">,</span> args<span class="token punctuation">:</span> <span class="token builtin">unknown</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">unknown</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>effect<span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//在监听函数中，又改变了依赖数据，按正常逻辑是会不断的触发监听函数的。</span>
  <span class="token comment">//但通过effectStack.includes(effect)这么一个判断逻辑，自然而然就避免了递归循环。</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>effectStack<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//effectStack中没有包含effect时，才走这一步</span>
    <span class="token function">cleanup</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span> <span class="token comment">//处理监听函数中可能有逻辑判断，导致有的数据不需要获取，所以可以避免每次更新</span>

    <span class="token comment">/**
    执行effect--&gt;把effect放入到栈中--&gt;
    执行fn，触发get--&gt;触发track--&gt;
    触发effectStack[effectStack.length-1]，收集依赖--&gt;
    添加dep（[effect]）到effect.deps--&gt;执行完fn，effectStack出栈
    */</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">//将本effect推到effect栈中</span>

      <span class="token comment">/*[effect = function reactiveEffect(...args: unknown[]): unknown {
        return run(effect, fn, args)
      } ]*/</span>
      effectStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
      <span class="token comment">//调用传进来的函数，触发get，具体逻辑往下看baseHandlers.ts</span>
      <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
      <span class="token comment">//执行原始函数并返回</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token comment">// console.log('effectStack出栈')</span>
      effectStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 清除effect.deps的依赖，就可以更新targetMap{
   targetMap{
     key:{
       set([effect]);//这其中的依赖
     }
   }
 }，就可以避免不必要的重复更新
 * @param effect 
 */</span>
<span class="token keyword">function</span> <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token parameter">effect<span class="token punctuation">:</span> ReactiveEffect</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> deps <span class="token punctuation">}</span> <span class="token operator">=</span> effect
  <span class="token keyword">if</span> <span class="token punctuation">(</span>deps<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> deps<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    deps<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> shouldTrack <span class="token operator">=</span> <span class="token boolean">true</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">pauseTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  shouldTrack <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">resumeTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  shouldTrack <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

<span class="token comment">//{a:1}  </span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">:</span> object<span class="token punctuation">,</span> <span class="token keyword">type</span><span class="token punctuation">:</span> OperationTypes<span class="token punctuation">,</span> key<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">unknown</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldTrack <span class="token operator">||</span> effectStack<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> effect <span class="token operator">=</span> effectStack<span class="token punctuation">[</span>effectStack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>

  <span class="token comment">/**
    //render逻辑
    effect = function reactiveEffect(...args: unknown[]): unknown {
      return run(effect, fn, args)
      ==&gt;fn--&gt;render
    }
  */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token operator">===</span> OperationTypes<span class="token punctuation">.</span><span class="token constant">ITERATE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    key <span class="token operator">=</span> <span class="token constant">ITERATE_KEY</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * targetMap 存储着原始数据到操作类型到具体操作的东西
   * target-&gt;depsMap{key-&gt;dep{-&gt;effect}}
   {
     a:1
   }
   * {
   *  target:{
   *    key(对象对应的某一个key)):Set([effect])
   *  }
   * }
   */</span>
  <span class="token keyword">let</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>depsMap <span class="token operator">===</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    targetMap<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">(</span>depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token operator">!</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dep <span class="token operator">===</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    depsMap<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>key<span class="token operator">!</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dep<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
    effect<span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span>onTrack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">onTrack</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        effect<span class="token punctuation">,</span>
        target<span class="token punctuation">,</span>
        <span class="token keyword">type</span><span class="token punctuation">,</span>
        key
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span>
  <span class="token parameter">target<span class="token punctuation">:</span> object<span class="token punctuation">,</span>
  <span class="token keyword">type</span><span class="token punctuation">:</span> OperationTypes<span class="token punctuation">,</span>
  key<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span>
  extraInfo<span class="token operator">?</span><span class="token punctuation">:</span> DebuggerEventExtraInfo</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * targetMap 存储着原始数据到操作类型到具体操作的东西
   * target-&gt;depsMap{key-&gt;dep{-&gt;effect}}
   * {
   *  target:{
   *    key(get、set):Set([effect])
   *  }
   * }
   */</span>
  <span class="token keyword">const</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>depsMap <span class="token operator">===</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// never been tracked</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> effects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token operator">&lt;</span>ReactiveEffect<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> computedRunners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token operator">&lt;</span>ReactiveEffect<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token operator">===</span> OperationTypes<span class="token punctuation">.</span><span class="token constant">CLEAR</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// collection being cleared, trigger all effects for target</span>
    depsMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">dep</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">addRunners</span><span class="token punctuation">(</span>effects<span class="token punctuation">,</span> computedRunners<span class="token punctuation">,</span> dep<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// schedule runs for SET | ADD | DELETE</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">addRunners</span><span class="token punctuation">(</span>effects<span class="token punctuation">,</span> computedRunners<span class="token punctuation">,</span> depsMap<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// also run for iteration key on ADD | DELETE</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token operator">===</span> OperationTypes<span class="token punctuation">.</span><span class="token constant">ADD</span> <span class="token operator">||</span> <span class="token keyword">type</span> <span class="token operator">===</span> OperationTypes<span class="token punctuation">.</span><span class="token constant">DELETE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//对于push操作，length已经会变得相同，不会触发两次trigger，所以新增需要特殊处理</span>
      <span class="token keyword">const</span> iterationKey <span class="token operator">=</span> <span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'length'</span> <span class="token punctuation">:</span> <span class="token constant">ITERATE_KEY</span>
      <span class="token function">addRunners</span><span class="token punctuation">(</span>effects<span class="token punctuation">,</span> computedRunners<span class="token punctuation">,</span> depsMap<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>iterationKey<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">effect<span class="token punctuation">:</span> ReactiveEffect</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">scheduleRun</span><span class="token punctuation">(</span>effect<span class="token punctuation">,</span> target<span class="token punctuation">,</span> <span class="token keyword">type</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> extraInfo<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// Important: computed effects must be run first so that computed getters</span>
  <span class="token comment">// can be invalidated before any normal effects that depend on them are run.</span>
  computedRunners<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span>
  <span class="token comment">//[effect]</span>
  effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">addRunners</span><span class="token punctuation">(</span>
  <span class="token parameter">effects<span class="token punctuation">:</span> Set<span class="token operator">&lt;</span>ReactiveEffect<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  computedRunners<span class="token punctuation">:</span> Set<span class="token operator">&lt;</span>ReactiveEffect<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  effectsToAdd<span class="token punctuation">:</span> Set<span class="token operator">&lt;</span>ReactiveEffect<span class="token operator">&gt;</span> <span class="token operator">|</span> undefined</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>effectsToAdd <span class="token operator">!==</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    effectsToAdd<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effect</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span>computed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        computedRunners<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        effects<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">scheduleRun</span><span class="token punctuation">(</span>
  <span class="token parameter">effect<span class="token punctuation">:</span> ReactiveEffect<span class="token punctuation">,</span>
  target<span class="token punctuation">:</span> object<span class="token punctuation">,</span>
  <span class="token keyword">type</span><span class="token punctuation">:</span> OperationTypes<span class="token punctuation">,</span>
  key<span class="token punctuation">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span>
  extraInfo<span class="token operator">?</span><span class="token punctuation">:</span> DebuggerEventExtraInfo</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span>onTrigger<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> event<span class="token punctuation">:</span> DebuggerEvent <span class="token operator">=</span> <span class="token punctuation">{</span>
      effect<span class="token punctuation">,</span>
      target<span class="token punctuation">,</span>
      key<span class="token punctuation">,</span>
      <span class="token keyword">type</span>
    <span class="token punctuation">}</span>
    effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">onTrigger</span><span class="token punctuation">(</span>extraInfo <span class="token operator">?</span> <span class="token function">extend</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> extraInfo<span class="token punctuation">)</span> <span class="token punctuation">:</span> event<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span>scheduler <span class="token operator">!==</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">scheduler</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="basehandlers-ts"><a href="#basehandlers-ts" aria-hidden="true" class="header-anchor">#</a> baseHandlers.ts</h3> <p>effect.run函数中调用，触发get</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> reactive<span class="token punctuation">,</span> <span class="token keyword">readonly</span><span class="token punctuation">,</span> toRaw <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./reactive'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> OperationTypes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./operations'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> track<span class="token punctuation">,</span> trigger <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./effect'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">LOCKED</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./lock'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> isObject<span class="token punctuation">,</span> hasOwn<span class="token punctuation">,</span> isSymbol<span class="token punctuation">,</span> hasChanged <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/shared'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> isRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./ref'</span>

<span class="token keyword">const</span> builtInSymbols <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>
  Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>Symbol<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>Symbol <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>isSymbol<span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment">/**
 * 创建proxy里面的get处理函数
 * @param isReadonly 否是是处理只读
 */</span>
<span class="token keyword">function</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token parameter">isReadonly<span class="token punctuation">:</span> <span class="token builtin">boolean</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * get函数
   */</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">:</span> object<span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">,</span> receiver<span class="token punctuation">:</span> object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取到Reflect执行的结果</span>

    <span class="token comment">// yi={a:</span>
    <span class="token comment">//   {</span>
    <span class="token comment">//   b:1</span>
    <span class="token comment">// }}</span>
    <span class="token comment">//yi.a</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
    <span class="token comment">//防止key为Symbol的内置对象，比如 Symbol.iterator</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSymbol</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> builtInSymbols<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> res
    <span class="token punctuation">}</span>
    <span class="token comment">//如果是ref包装过的数据，直接调用Value触发get，获取值之后，再返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span>value
    <span class="token punctuation">}</span>
    <span class="token comment">//TODO:看着像跟踪，依赖收集，后面再看</span>
    <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> OperationTypes<span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token comment">//{a:1}  `get` a</span>
    <span class="token comment">/**
     * 对深层对象再次包装，
     * 判断内层是否是对象，不是就直接返回
     * 如果是对象，判断是否是要做只读处理，
     * 如果是只读，就调用只读
     * 不是的话，就调用
     */</span>
    <span class="token keyword">return</span> <span class="token function">isObject</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
      <span class="token operator">?</span> isReadonly
        <span class="token operator">?</span> <span class="token comment">// need to lazy access readonly and reactive here to avoid</span>
        <span class="token comment">// circular dependency</span>
        <span class="token keyword">readonly</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
        <span class="token punctuation">:</span> <span class="token function">reactive</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
      <span class="token punctuation">:</span> res
  <span class="token punctuation">}</span>
	<span class="token comment">//嵌套数据没有递归，当用到了再去处理。</span>
  <span class="token comment">/**
    c={
      a:{
        b{

        }
      }
    }
  */</span>

  <span class="token comment">/**
  
    obj={
      a:{
        b:{
          c:1
        }
      }
    }
  */</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * proxy中set方法的优化,包含只读数据的处理和响应式数据的处理
 * @param target
 * @param key
 * @param value
 * @param receiver
 */</span>
<span class="token keyword">function</span> <span class="token keyword">set</span><span class="token punctuation">(</span>
  <span class="token parameter">target<span class="token punctuation">:</span> object<span class="token punctuation">,</span>
  key<span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">,</span>
  value<span class="token punctuation">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span>
  receiver<span class="token punctuation">:</span> object</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
  <span class="token comment">//获取原始的数据</span>
  value <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token comment">//拿到之前的老值</span>
  <span class="token keyword">const</span> oldValue <span class="token operator">=</span> <span class="token punctuation">(</span>target <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token comment">//判断老数据是否是已经被ref处理过的，并且新数据没有没ref处理过</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isRef</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//更新老数据，并且返回</span>
    <span class="token comment">// 如果 value 不是响应式数据，则需要将其赋值给 oldValue，调用set value，</span>
    <span class="token comment">//如果 isObject(value) ，则会经过 reactive 再包装一次，将其变成响应式数据</span>
    oldValue<span class="token punctuation">.</span>value <span class="token operator">=</span> value
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   *   key是target自己的属性
   *
   *   这个方法是解决 数组push时，会调用两次 set 的情况，比如 arr.push(1)
   *   第一次set，在数组尾部添加1
   *   第二次set，给数组添加length属性
   *   hasOwnProperty 方法用来判断目标对象是否含有指定属性。数组本身就有length的属性，所以这里是 true
   */</span>
  <span class="token keyword">const</span> hadKey <span class="token operator">=</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token comment">//执行返回结果</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
  <span class="token comment">// don't trigger if target is something up in the prototype chain of original</span>
  <span class="token comment">//target 如果只读 或者 存在于 reactiveToRaw 则不进入条件，reactiveToRaw 储存着代理后的对象</span>
  <span class="token comment">//已经是代理之后的值了</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">===</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>receiver<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//如果是原始数据原型链上自己的操作，就不触发</span>
    <span class="token comment">/* istanbul ignore else */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> extraInfo <span class="token operator">=</span> <span class="token punctuation">{</span> oldValue<span class="token punctuation">,</span> newValue<span class="token punctuation">:</span> value <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hadKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> OperationTypes<span class="token punctuation">.</span><span class="token constant">ADD</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> extraInfo<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasChanged</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> OperationTypes<span class="token punctuation">.</span><span class="token constant">SET</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> extraInfo<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">//属性新增，触发 ADD 枚举</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hadKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> OperationTypes<span class="token punctuation">.</span><span class="token constant">ADD</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasChanged</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//当新值与旧值不相等时</span>
        <span class="token comment">// 属性修改，触发 SET 枚举</span>
        <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> OperationTypes<span class="token punctuation">.</span><span class="token constant">SET</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span>

<span class="token comment">//删除属性处理</span>
<span class="token keyword">function</span> <span class="token function">deleteProperty</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">:</span> object<span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hadKey <span class="token operator">=</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token keyword">const</span> oldValue <span class="token operator">=</span> <span class="token punctuation">(</span>target <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">deleteProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&amp;&amp;</span> hadKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* istanbul ignore else */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> OperationTypes<span class="token punctuation">.</span><span class="token constant">DELETE</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span> oldValue <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> OperationTypes<span class="token punctuation">.</span><span class="token constant">DELETE</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span>
<span class="token comment">//查询属性处理</span>
<span class="token keyword">function</span> <span class="token function">has</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">:</span> object<span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> OperationTypes<span class="token punctuation">.</span><span class="token constant">HAS</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span>
<span class="token comment">//获取key的属性处理</span>
<span class="token keyword">function</span> <span class="token function">ownKeys</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">:</span> object</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> OperationTypes<span class="token punctuation">.</span><span class="token constant">ITERATE</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//可变数据处理handler</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> mutableHandlers<span class="token punctuation">:</span> ProxyHandler<span class="token operator">&lt;</span>object<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">set</span><span class="token punctuation">,</span>
  deleteProperty<span class="token punctuation">,</span>
  has<span class="token punctuation">,</span>
  ownKeys
<span class="token punctuation">}</span>

<span class="token comment">//只读数据handler</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> readonlyHandlers<span class="token punctuation">:</span> ProxyHandler<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">//创建get</span>
  <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">//创建set</span>
  <span class="token keyword">set</span><span class="token punctuation">(</span>
    target<span class="token punctuation">:</span> object<span class="token punctuation">,</span>
    key<span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">,</span>
    value<span class="token punctuation">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span>
    receiver<span class="token punctuation">:</span> object
  <span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
    <span class="token comment">//判断是否已经锁住</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">LOCKED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Set operation on key &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">String</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; failed: target is readonly.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          target
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function">deleteProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">:</span> object<span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">LOCKED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Delete operation on key &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">String</span><span class="token punctuation">(</span>
            key
          <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; failed: target is readonly.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          target
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">deleteProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  has<span class="token punctuation">,</span>
  ownKeys
<span class="token punctuation">}</span>
</code></pre></div><h3 id="小结"><a href="#小结" aria-hidden="true" class="header-anchor">#</a> 小结</h3> <p>梳理一下上面的流程</p> <p><img src="/sourceCode/vue3/dataResponseArchitecture2.png" alt="dataResponseArchitecture2"></p> <div class="language- extra-class"><pre class="language-text"><code>reactive ==&gt;把数据处理成为响应式数据
    proxy
    targetMap---对应下面
    {
        {a:1} :{
            a:[effect()]
        }
    }

effect==&gt;   
1.首先会执行一次对应监听的函数
2.修改对应监听函数内使用的响应式数据，对应的监听函数就会重新执行，重新执行的过程就会获取到新的数据

effect(fn)

    ==&gt;  createReactiveEffect==warpFn==&gt;lazy ==Effect()==&gt; run(effect, fn, args)
    ==&gt; effectStack(维护一个堆栈)
    ==&gt; effectStack.push (Effect)
    ==&gt; fn()
    ==&gt; get==&gt;track(target,get,'key')==&gt; {
        target:{
            key:[Effect]
        }
    }
    基本数据类型不能处理成为 reactive 数据,基本数据类型能不能被监听，所以有了 Ref 
</code></pre></div><h3 id="ref"><a href="#ref" aria-hidden="true" class="header-anchor">#</a> ref</h3> <p>处理基本数据</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> track<span class="token punctuation">,</span> trigger <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./effect'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> OperationTypes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./operations'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> isObject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/shared'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> reactive <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./reactive'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ComputedRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./computed'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CollectionTypes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./collectionHandlers'</span>

<span class="token comment">/**
 * Ref存在的原因是对基本数据的处理
 */</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Ref</span><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  _isRef<span class="token punctuation">:</span> <span class="token boolean">true</span>
  value<span class="token punctuation">:</span> UnwrapRef<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> convert <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">unknown</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>val<span class="token punctuation">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token parameter"><span class="token constant">T</span></span> <span class="token operator">=&gt;</span>
  <span class="token function">isObject</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">reactive</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">:</span> val

<span class="token keyword">export</span> <span class="token keyword">function</span> ref<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">Ref</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>raw<span class="token punctuation">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token constant">T</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> ref<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>raw<span class="token punctuation">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Ref<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> ref<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Ref<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token parameter">raw<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">unknown</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> raw
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * 如果是对象，则用 reactive 方法 包装 raw,不是就返回原始值
   * const convert = (val: any): any =&gt; (isObject(val) ? reactive(val) : val)
   */</span>
  raw <span class="token operator">=</span> <span class="token function">convert</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span>

  <span class="token comment">/**
   * 返回v，Ref类型，获取value值的时候，调用track方法，存value值时，调用 trigger方法
   * v.value触发get，v.value=2触发set
   */</span>
  <span class="token keyword">const</span> r <span class="token operator">=</span> <span class="token punctuation">{</span>
    _isRef<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//TODO:why track</span>
      <span class="token function">track</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> OperationTypes<span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> raw
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//对数据包装</span>
      raw <span class="token operator">=</span> <span class="token function">convert</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span>
      <span class="token comment">//TODO:why trigger</span>
      <span class="token function">trigger</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> OperationTypes<span class="token punctuation">.</span><span class="token constant">SET</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> r <span class="token keyword">as</span> Ref
<span class="token punctuation">}</span>

<span class="token comment">//判断是否是ref</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isRef</span><span class="token punctuation">(</span><span class="token parameter">r<span class="token punctuation">:</span> <span class="token builtin">any</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> r <span class="token keyword">is</span> Ref <span class="token punctuation">{</span>
  <span class="token keyword">return</span> r <span class="token operator">?</span> r<span class="token punctuation">.</span>_isRef <span class="token operator">===</span> <span class="token boolean">true</span> <span class="token punctuation">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 把代理对象转换为ref
 * @param object
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> toRefs<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">object</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
  object<span class="token punctuation">:</span> <span class="token constant">T</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token constant">K</span> <span class="token keyword">in</span> <span class="token keyword">keyof</span> <span class="token constant">T</span><span class="token punctuation">]</span><span class="token punctuation">:</span> Ref<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">[</span><span class="token constant">K</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">}</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ret<span class="token punctuation">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ret<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">toProxyRef</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> ret
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 转换ref数据
 * @param object
 * @param key
 */</span>
<span class="token keyword">function</span> toProxyRef<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">object</span><span class="token punctuation">,</span> <span class="token constant">K</span> <span class="token keyword">extends</span> <span class="token class-name">keyof</span> <span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
  object<span class="token punctuation">:</span> <span class="token constant">T</span><span class="token punctuation">,</span>
  key<span class="token punctuation">:</span> <span class="token constant">K</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> Ref<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">[</span><span class="token constant">K</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    _isRef<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">any</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> object<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      object<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> newVal
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Recursively unwraps nested value bindings.</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> UnwrapRef<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  cRef<span class="token punctuation">:</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">ComputedRef</span><span class="token operator">&lt;</span>infer <span class="token constant">V</span><span class="token operator">&gt;</span> <span class="token operator">?</span> UnwrapRef<span class="token operator">&lt;</span><span class="token constant">V</span><span class="token operator">&gt;</span> <span class="token punctuation">:</span> <span class="token constant">T</span>
  ref<span class="token punctuation">:</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">Ref</span><span class="token operator">&lt;</span>infer <span class="token constant">V</span><span class="token operator">&gt;</span> <span class="token operator">?</span> UnwrapRef<span class="token operator">&lt;</span><span class="token constant">V</span><span class="token operator">&gt;</span> <span class="token punctuation">:</span> <span class="token constant">T</span>
  array<span class="token punctuation">:</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">Array</span><span class="token operator">&lt;</span>infer <span class="token constant">V</span><span class="token operator">&gt;</span> <span class="token operator">?</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>UnwrapRef<span class="token operator">&lt;</span><span class="token constant">V</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">:</span> <span class="token constant">T</span>
  object<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token constant">K</span> <span class="token keyword">in</span> <span class="token keyword">keyof</span> <span class="token constant">T</span><span class="token punctuation">]</span><span class="token punctuation">:</span> UnwrapRef<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">[</span><span class="token constant">K</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">ComputedRef</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span>
  <span class="token operator">?</span> <span class="token string">'cRef'</span>
  <span class="token punctuation">:</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">Ref</span>
    <span class="token operator">?</span> <span class="token string">'ref'</span>
    <span class="token punctuation">:</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">Array</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span>
      <span class="token operator">?</span> <span class="token string">'array'</span>
      <span class="token punctuation">:</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">Function</span> <span class="token operator">|</span> CollectionTypes
        <span class="token operator">?</span> <span class="token string">'ref'</span> <span class="token comment">// bail out on types that shouldn't be unwrapped</span>
        <span class="token punctuation">:</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">object</span> <span class="token operator">?</span> <span class="token string">'object'</span> <span class="token punctuation">:</span> <span class="token string">'ref'</span><span class="token punctuation">]</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> track<span class="token punctuation">,</span> trigger <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./effect'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> OperationTypes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./operations'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> isObject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@vue/shared'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> reactive <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./reactive'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ComputedRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./computed'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CollectionTypes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./collectionHandlers'</span>

<span class="token comment">/**
 * Ref存在的原因是对基本数据的处理
 */</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Ref</span><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  _isRef<span class="token punctuation">:</span> <span class="token boolean">true</span>
  value<span class="token punctuation">:</span> UnwrapRef<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> convert <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">unknown</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>val<span class="token punctuation">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token parameter"><span class="token constant">T</span></span> <span class="token operator">=&gt;</span>
  <span class="token function">isObject</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">reactive</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">:</span> val

<span class="token keyword">export</span> <span class="token keyword">function</span> ref<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">Ref</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>raw<span class="token punctuation">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token constant">T</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> ref<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>raw<span class="token punctuation">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Ref<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> ref<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Ref<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token parameter">raw<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">unknown</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> raw
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * 如果是对象，则用 reactive 方法 包装 raw,不是就返回原始值
   * const convert = (val: any): any =&gt; (isObject(val) ? reactive(val) : val)
   */</span>
  raw <span class="token operator">=</span> <span class="token function">convert</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span>

  <span class="token comment">/**
   * 返回v，Ref类型，获取value值的时候，调用track方法，存value值时，调用 trigger方法
   * v.value触发get，v.value=2触发set
   */</span>
  <span class="token keyword">const</span> r <span class="token operator">=</span> <span class="token punctuation">{</span>
    _isRef<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//TODO:why track</span>
      <span class="token function">track</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> OperationTypes<span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> raw
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//对数据包装</span>
      raw <span class="token operator">=</span> <span class="token function">convert</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span>
      <span class="token comment">//TODO:why trigger</span>
      <span class="token function">trigger</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> OperationTypes<span class="token punctuation">.</span><span class="token constant">SET</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> r <span class="token keyword">as</span> Ref
<span class="token punctuation">}</span>

<span class="token comment">//判断是否是ref</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isRef</span><span class="token punctuation">(</span><span class="token parameter">r<span class="token punctuation">:</span> <span class="token builtin">any</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> r <span class="token keyword">is</span> Ref <span class="token punctuation">{</span>
  <span class="token keyword">return</span> r <span class="token operator">?</span> r<span class="token punctuation">.</span>_isRef <span class="token operator">===</span> <span class="token boolean">true</span> <span class="token punctuation">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 把代理对象转换为ref
 * @param object
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> toRefs<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">object</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
  object<span class="token punctuation">:</span> <span class="token constant">T</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token constant">K</span> <span class="token keyword">in</span> <span class="token keyword">keyof</span> <span class="token constant">T</span><span class="token punctuation">]</span><span class="token punctuation">:</span> Ref<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">[</span><span class="token constant">K</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">}</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ret<span class="token punctuation">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ret<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">toProxyRef</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> ret
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 转换ref数据
 * @param object
 * @param key
 */</span>
<span class="token keyword">function</span> toProxyRef<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">object</span><span class="token punctuation">,</span> <span class="token constant">K</span> <span class="token keyword">extends</span> <span class="token class-name">keyof</span> <span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
  object<span class="token punctuation">:</span> <span class="token constant">T</span><span class="token punctuation">,</span>
  key<span class="token punctuation">:</span> <span class="token constant">K</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> Ref<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">[</span><span class="token constant">K</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    _isRef<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">any</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> object<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      object<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> newVal
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Recursively unwraps nested value bindings.</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> UnwrapRef<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  cRef<span class="token punctuation">:</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">ComputedRef</span><span class="token operator">&lt;</span>infer <span class="token constant">V</span><span class="token operator">&gt;</span> <span class="token operator">?</span> UnwrapRef<span class="token operator">&lt;</span><span class="token constant">V</span><span class="token operator">&gt;</span> <span class="token punctuation">:</span> <span class="token constant">T</span>
  ref<span class="token punctuation">:</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">Ref</span><span class="token operator">&lt;</span>infer <span class="token constant">V</span><span class="token operator">&gt;</span> <span class="token operator">?</span> UnwrapRef<span class="token operator">&lt;</span><span class="token constant">V</span><span class="token operator">&gt;</span> <span class="token punctuation">:</span> <span class="token constant">T</span>
  array<span class="token punctuation">:</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">Array</span><span class="token operator">&lt;</span>infer <span class="token constant">V</span><span class="token operator">&gt;</span> <span class="token operator">?</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>UnwrapRef<span class="token operator">&lt;</span><span class="token constant">V</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">:</span> <span class="token constant">T</span>
  object<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token constant">K</span> <span class="token keyword">in</span> <span class="token keyword">keyof</span> <span class="token constant">T</span><span class="token punctuation">]</span><span class="token punctuation">:</span> UnwrapRef<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">[</span><span class="token constant">K</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">ComputedRef</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span>
  <span class="token operator">?</span> <span class="token string">'cRef'</span>
  <span class="token punctuation">:</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">Ref</span>
    <span class="token operator">?</span> <span class="token string">'ref'</span>
    <span class="token punctuation">:</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">Array</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span>
      <span class="token operator">?</span> <span class="token string">'array'</span>
      <span class="token punctuation">:</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">Function</span> <span class="token operator">|</span> CollectionTypes
        <span class="token operator">?</span> <span class="token string">'ref'</span> <span class="token comment">// bail out on types that shouldn't be unwrapped</span>
        <span class="token punctuation">:</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">object</span> <span class="token operator">?</span> <span class="token string">'object'</span> <span class="token punctuation">:</span> <span class="token string">'ref'</span><span class="token punctuation">]</span>

</code></pre></div><p>用法</p> <p><img src="/sourceCode/vue3/ref.png" alt="ref"></p> <h2 id="vnode"><a href="#vnode" aria-hidden="true" class="header-anchor">#</a> vnode</h2> <p><img src="/sourceCode/vue3/1598540303402_ECEB2EA2-E1E6-4426-A0BD-F07543713AC6.png" alt="1598540303402_ECEB2EA2-E1E6-4426-A0BD-F07543713AC6"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>foo<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> bar <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>




<span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token punctuation">{</span>
    tag<span class="token punctuation">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span>
    children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> tag<span class="token punctuation">:</span> <span class="token string">'p'</span><span class="token punctuation">,</span> children<span class="token punctuation">:</span> <span class="token string">'foo'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> tag<span class="token punctuation">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span> children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span> tag<span class="token punctuation">:</span> <span class="token string">'p'</span><span class="token punctuation">,</span> children<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>bar <span class="token punctuation">}</span>
        <span class="token punctuation">]</span> 
        <span class="token punctuation">}</span><span class="token punctuation">,</span> 
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">//v3会增加一个，动态节点添加到dynamicChildren，之后diff直接对比这里</span>
    dynamicChildren<span class="token punctuation">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span> tag<span class="token punctuation">:</span> <span class="token string">'p'</span><span class="token punctuation">,</span> children<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>bar <span class="token punctuation">}</span><span class="token punctuation">,</span> 
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token comment">//使用到了BlockTree   上图中_createBlock</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createVNode <span class="token keyword">as</span> _createVNode<span class="token punctuation">,</span> toDisplayString <span class="token keyword">as</span> _toDisplayString<span class="token punctuation">,</span> Fragment <span class="token keyword">as</span> _Fragment<span class="token punctuation">,</span> openBlock <span class="token keyword">as</span> _openBlock<span class="token punctuation">,</span> createBlock <span class="token keyword">as</span> _createBlock <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vue&quot;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">_ctx<span class="token punctuation">,</span> _cache<span class="token punctuation">,</span> $props<span class="token punctuation">,</span> $setup<span class="token punctuation">,</span> $data<span class="token punctuation">,</span> $options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">_openBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_createBlock</span><span class="token punctuation">(</span>_Fragment<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">_createVNode</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> onClick<span class="token punctuation">:</span> _ctx<span class="token punctuation">.</span>go <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">,</span> <span class="token number">8</span> <span class="token comment">/* PROPS */</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;onClick&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">_createVNode</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> onClick<span class="token punctuation">:</span> _ctx<span class="token punctuation">.</span>go <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">_toDisplayString</span><span class="token punctuation">(</span>_ctx<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">9</span> <span class="token comment">/* TEXT, PROPS */</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;onClick&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">64</span> <span class="token comment">/* STABLE_FRAGMENT */</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Check the console for the AST</span>
<span class="token comment">//对比完成靶向更新</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/FE/sourceCode/vue2.html" class="prev">VUE2源码解析</a></span> <span class="next"><a href="/FE/sourceCode/redux.html">redux源码解析</a>→
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5c6037cb.js" defer></script><script src="/assets/js/2.082e12d9.js" defer></script><script src="/assets/js/46.e605b212.js" defer></script>
  </body>
</html>
